<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Activation Board</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#16a34a">
  <style>
    :root{--cell:14px;--gap:3px;--radius:3px;--bg:#f7f7f8;--fg:#111;}
    html,body{margin:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;}
    body{background:var(--bg);color:var(--fg);}
    header{display:flex;align-items:center;gap:8px;padding:12px 16px;position:sticky;top:0;background:var(--bg);z-index:10}
    header h1{font-size:16px;margin:0 8px 0 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select, input[type="text"]{padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
    button{padding:8px 10px;border:1px solid #ddd;background:#fff;border-radius:10px;cursor:pointer}
    button.primary{background:#16a34a;color:#fff;border-color:#16a34a}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .chip.active{background:#eaffee;border-color:#16a34a;color:#166534}
    .board{padding:0 12px 16px;overflow:auto}
    .weeks{display:flex;gap:var(--gap)}
    .col{display:flex;flex-direction:column;gap:var(--gap)}
    .cell{width:var(--cell);height:var(--cell);border-radius:var(--radius);box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);background:#e5e7eb}
    .cell.out{opacity:.25}
    .legend{display:flex;align-items:center;gap:6px;margin:6px 12px 12px}
    .legend .cell{box-shadow:none}
    footer{padding:10px 12px;color:#666;font-size:12px}
    details{padding:0 12px 12px}
    .habitbar{padding:8px 12px;display:flex;gap:8px;overflow:auto}
    .spacer{flex:1}
    .board{display:flex;gap:6px;padding:0 12px 16px;overflow:auto}
    .ylabels{display:flex;flex-direction:column;gap:var(--gap);position:sticky;left:0}
    .ylabels div{height:var(--cell);line-height:var(--cell);font-size:10px;color:#666;padding-right:4px}
    .hint{margin:6px 12px;color:#666;font-size:12px}
    .hidden{display:none}
  </style>
</head>
<body>
<header>
  <h1>Activation Board</h1>
  <div class="row">
    <button id="yearPrev">⟵</button>
    <select id="yearSel"></select>
    <button id="yearNext">⟶</button>
  </div>
  <div class="spacer"></div>
  <button id="exportBtn">匯出</button>
  <label>
    <input type="file" id="importFile" accept="application/json" class="hidden">
    <button id="importBtn">匯入</button>
  </label>
</header>

<div class="habitbar" id="habitBar"></div>

<!-- 新增：一鍵打卡今天 -->
<button id="markTodayBtn" class="primary">今天 ✓</button>

<!-- 新增：提示目前指到/點到的日期 -->
<div id="hint" class="hint"></div>

<div class="legend" id="legend"></div>
<div class="board">
  <div class="ylabels" id="ylabels"></div>
  <div class="weeks" id="weeks"></div>
</div>

<details>
  <summary>新增/管理習慣</summary>
  <div style="padding:8px 0;display:flex;gap:8px;align-items:center">
    <input type="text" id="newHabitName" placeholder="習慣名稱（如 Meditation）">
    <input type="color" id="newHabitColor" value="#16a34a">
    <button id="addHabitBtn" class="primary">新增</button>
  </div>
</details>

<footer>點格子即可打卡/取消。選擇「全部」＝同一天完成的習慣越多顏色越深。支援離線，iOS 可加到主畫面。</footer>

<script>
// ===== Polyfill：某些舊瀏覽器沒有 crypto.randomUUID =====
if (!('crypto' in window) || !('randomUUID' in crypto)) {
  window.crypto = window.crypto || {};
  crypto.randomUUID = function () {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c){
      var r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8);
      return v.toString(16);
    });
  };
}

// ====== App 狀態 ======
var StoreKey = 'activationBoard.v1';
function load(){ try{ return JSON.parse(localStorage.getItem(StoreKey)) || def(); }catch(e){ return def(); } }
function save(s){ localStorage.setItem(StoreKey, JSON.stringify(s)); }
function def(){ return { habits:[{ id: crypto.randomUUID(), name:'Meditation', color:'#16a34a', days:{} }], selected:null }; }
function ymd(d){ return d.toISOString().slice(0,10); }
function renderYLabels(){
  const y = document.getElementById('ylabels');
  if(!y) return;
  y.innerHTML = '';
  ['日','一','二','三','四','五','六'].forEach(t=>{
    const d = document.createElement('div');
    d.textContent = t;
    y.appendChild(d);
  });
}

var state = load();
var today = new Date();
var currentYear = today.getFullYear();
var startYear = currentYear - 2;
var endYear = currentYear + 3;

// ====== 年份選單 ======
var yearSel = document.getElementById('yearSel');
function fillYears(){
  yearSel.innerHTML = '';
  for (var y=startYear;y<=endYear;y++){
    var o=document.createElement('option'); o.value=y; o.textContent=y; yearSel.appendChild(o);
  }
  yearSel.value = currentYear;
}
document.getElementById('yearPrev').onclick=function(){ currentYear--; yearSel.value=currentYear; render(); };
document.getElementById('yearNext').onclick=function(){ currentYear++; yearSel.value=currentYear; render(); };
yearSel.onchange=function(e){ currentYear=parseInt(e.target.value,10); render(); };

// ====== 習慣列 ======
var habitBar = document.getElementById('habitBar');
function renderHabits(){
  habitBar.innerHTML='';
  var all=document.createElement('div'); all.className='chip'+(state.selected===null?' active':''); all.textContent='全部';
  all.onclick=function(){ state.selected=null; save(state); render(); };
  habitBar.appendChild(all);

  state.habits.forEach(function(h){
    var chip=document.createElement('div');
    chip.className='chip'+(state.selected===h.id?' active':'');
    chip.innerHTML='<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:'+h.color+';margin-right:6px"></span>'+h.name;
    chip.onclick=function(){ state.selected=h.id; save(state); render(); };
    chip.oncontextmenu=function(e){ e.preventDefault(); if(confirm('刪除「'+h.name+'」？')){ state.habits=state.habits.filter(function(x){return x.id!==h.id}); if(state.selected===h.id) state.selected=null; save(state); render(); } };
    habitBar.appendChild(chip);
  });
}
document.getElementById('addHabitBtn').onclick=function(){
  var name=document.getElementById('newHabitName').value.trim()||'Habit';
  var color=document.getElementById('newHabitColor').value;
  state.habits.push({ id: crypto.randomUUID(), name:name, color:color, days:{} });
  state.selected = state.habits[state.habits.length-1].id;
  document.getElementById('newHabitName').value='';
  save(state); render();
};

// ====== 日曆熱圖 ======
var weeksEl=document.getElementById('weeks');
var legendEl=document.getElementById('legend');

function firstSunday(d){ var s=new Date(d.getFullYear(),d.getMonth(),d.getDate()); var w=s.getDay(); s.setDate(s.getDate()-w); return s; }
function lastSaturday(d){ var e=new Date(d.getFullYear(),d.getMonth(),d.getDate()); var w=e.getDay(); e.setDate(e.getDate()+(6-w)); return e; }
function daysBetween(a,b){ var out=[], d=new Date(a); while(d<=b){ out.push(new Date(d)); d.setDate(d.getDate()+1); } return out; }
function mixColor(hex,ratio){
  if(ratio<=0.0001) return '#e5e7eb';
  var c=hex.replace('#','');
  var r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
  var rr=Math.round(ratio*r+(1-ratio)*229), gg=Math.round(ratio*g+(1-ratio)*231), bb=Math.round(ratio*b+(1-ratio)*235);
  return 'rgb('+rr+','+gg+','+bb+')';
}
function renderLegend(base){
  legendEl.innerHTML='強度：';
  for(var i=0;i<5;i++){ var c=document.createElement('div'); c.className='cell'; c.style.background=mixColor(base, i/4); legendEl.appendChild(c); }
}

function renderBoard(){
  weeksEl.innerHTML='';
  var ys=new Date(currentYear,0,1), ye=new Date(currentYear,11,31);
  var gs=firstSunday(ys), ge=lastSaturday(ye), dates=daysBetween(gs,ge);

  var isSingle = state.selected!==null;
  var base = '#16a34a'; var map={};
  if(isSingle){
    var h = state.habits.find(function(x){ return x.id===state.selected; });
    base = (h && h.color) || base;
    if(h){ Object.keys(h.days).forEach(function(k){ map[k]=1; }); }
  }else{
    state.habits.forEach(function(h){ Object.keys(h.days).forEach(function(k){ map[k]=(map[k]||0)+1; }); });
  }
  var maxI = Math.max(1).concat ? 1 : 1; // 保險，不用展開運算子
  Object.keys(map).forEach(function(k){ if(map[k]>maxI) maxI=map[k]; });
  renderLegend(base);

  for(var col=0; col<dates.length; col+=7){
    var column=document.createElement('div'); column.className='col';
    for(var row=0; row<7; row++){
      var d=dates[col+row], key=ymd(d), val=map[key]||0;
      var ratio = isSingle ? (val>0?1:0) : (val/maxI);
      var cell=document.createElement('div');
      cell.className='cell'+(d<ys||d>ye?' out':''); cell.style.background=mixColor(base, ratio);
      cell.title=key+(isSingle?(val?' ✓':'' ):(val?' ×'+val:''));
      cell.onmouseenter = ()=>{ const hEl = document.getElementById('hint'); if(hEl) hEl.textContent = key; };
      cell.onmouseleave = ()=>{ const hEl = document.getElementById('hint'); if(hEl) hEl.textContent = ''; };

      cell.onclick=function(dtKey){
        return function(){
          if(!isSingle){ alert('請先在上方選一個習慣，再點格子打卡。'); return; }
          var hh = state.habits.find(function(x){ return x.id===state.selected; });
          if(!hh) return;
          if(hh.days[dtKey]) delete hh.days[dtKey]; else hh.days[dtKey]=1;
          save(state); renderBoard();
        };
      }(key);
      column.appendChild(cell);
    }
    weeksEl.appendChild(column);
  }
}

function render(){ fillYears(); renderYLabels(); renderHabits(); renderBoard(); }
render();

document.getElementById('markTodayBtn').onclick = ()=>{
  if(state.selected === null){ alert('請先在上方點一個習慣'); return; }
  const key = ymd(new Date());
  const h = state.habits.find(x=>x.id===state.selected);
  if(!h) return;
  if(h.days[key]) delete h.days[key]; else h.days[key]=1;  // 切換今天
  save(state);
  renderBoard();
};

// ====== 匯出 / 匯入 ======
document.getElementById('exportBtn').onclick=function(){
  var blob=new Blob([JSON.stringify(state,null,2)], {type:'application/json;charset=utf-8'});
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='activation-board-'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(a.href);
};
var importFile=document.getElementById('importFile');
document.getElementById('importBtn').onclick=function(){ importFile.click(); };
importFile.onchange=function(e){
  var f=e.target.files[0]; if(!f) return;
  f.text().then(function(txt){
    var obj=JSON.parse(txt);
    if(!obj.habits) throw new Error('格式不正確');
    state=obj; save(state); render();
  }).catch(function(err){ alert('匯入失敗：'+err.message); });
};

// ====== 註冊 Service Worker ======
if('serviceWorker' in navigator){
  window.addEventListener('load', function(){ navigator.serviceWorker.register('./sw.js'); });
}
</script>

</body>
</html>
