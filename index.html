<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Activation Board</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#16a34a">
  <style>
    :root{--cell:14px;--gap:3px;--radius:3px;--bg:#f7f7f8;--fg:#111;}
    html,body{margin:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;}
    body{background:var(--bg);color:var(--fg);}
    header{display:flex;align-items:center;gap:8px;padding:12px 16px;position:sticky;top:0;background:var(--bg);z-index:10}
    header h1{font-size:16px;margin:0 8px 0 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select, input[type="text"]{padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
    button{padding:8px 10px;border:1px solid #ddd;background:#fff;border-radius:10px;cursor:pointer}
    button.primary{background:#16a34a;color:#fff;border-color:#16a34a}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .chip.active{background:#eaffee;border-color:#16a34a;color:#166534}
    .board{padding:0 12px 16px;overflow:auto}
    .weeks{display:flex;gap:var(--gap)}
    .col{display:flex;flex-direction:column;gap:var(--gap)}
    .cell{width:var(--cell);height:var(--cell);border-radius:var(--radius);box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);background:#e5e7eb}
    .cell.out{opacity:.25}
    .legend{display:flex;align-items:center;gap:6px;margin:6px 12px 12px}
    .legend .cell{box-shadow:none}
    footer{padding:10px 12px;color:#666;font-size:12px}
    details{padding:0 12px 12px}
    .habitbar{padding:8px 12px;display:flex;gap:8px;overflow:auto}
    .spacer{flex:1}
    .hidden{display:none}
  </style>
</head>
<body>
<header>
  <h1>Activation Board</h1>
  <div class="row">
    <button id="yearPrev">⟵</button>
    <select id="yearSel"></select>
    <button id="yearNext">⟶</button>
  </div>
  <div class="spacer"></div>
  <button id="exportBtn">匯出</button>
  <label>
    <input type="file" id="importFile" accept="application/json" class="hidden">
    <button id="importBtn">匯入</button>
  </label>
</header>

<div class="habitbar" id="habitBar"></div>
<div class="legend" id="legend"></div>
<div class="board"><div class="weeks" id="weeks"></div></div>

<details>
  <summary>新增/管理習慣</summary>
  <div style="padding:8px 0;display:flex;gap:8px;align-items:center">
    <input type="text" id="newHabitName" placeholder="習慣名稱（如 Meditation）">
    <input type="color" id="newHabitColor" value="#16a34a">
    <button id="addHabitBtn" class="primary">新增</button>
  </div>
</details>

<footer>點格子即可打卡/取消。選擇「全部」＝同一天完成的習慣越多顏色越深。支援離線，iOS 可加到主畫面。</footer>

<script>
const StoreKey = 'activationBoard.v1';
const today = new Date();
const startYear = today.getFullYear() - 2;
const endYear = today.getFullYear() + 3;

function load() { try { return JSON.parse(localStorage.getItem(StoreKey)) || defaultState() } catch { return defaultState() } }
function save(state) { localStorage.setItem(StoreKey, JSON.stringify(state)) }
function defaultState() { return { habits: [ { id: crypto.randomUUID(), name: 'Meditation', color: '#16a34a', days: {} } ], selected: null } }
function ymd(d){ return d.toISOString().slice(0,10) }

let state = load();
let currentYear = today.getFullYear();

const yearSel = document.getElementById('yearSel');
for (let y = startYear; y <= endYear; y++) { const opt = document.createElement('option'); opt.value = y; opt.textContent = y; yearSel.appendChild(opt); }
yearSel.value = currentYear;
document.getElementById('yearPrev').onclick = ()=>{ currentYear--; yearSel.value=currentYear; render() }
document.getElementById('yearNext').onclick = ()=>{ currentYear++; yearSel.value=currentYear; render() }
yearSel.onchange = e => { currentYear = parseInt(e.target.value,10); render() }

const habitBar = document.getElementById('habitBar');
function renderHabits() {
  habitBar.innerHTML = '';
  const all = document.createElement('div'); all.className = 'chip' + (state.selected===null ? ' active':''); all.textContent = '全部';
  all.onclick = ()=>{ state.selected=null; save(state); render() }; habitBar.appendChild(all);
  state.habits.forEach(h=>{
    const chip = document.createElement('div'); chip.className = 'chip' + (state.selected===h.id ? ' active':'');
    chip.innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${h.color};margin-right:6px"></span>${h.name}`;
    chip.onclick = ()=>{ state.selected=h.id; save(state); render() };
    chip.oncontextmenu = (e)=>{ e.preventDefault(); if(confirm(\`刪除「${h.name}」？\`)){ state.habits = state.habits.filter(x=>x.id!==h.id); if(state.selected===h.id) state.selected=null; save(state); render() } };
    habitBar.appendChild(chip);
  });
}
document.getElementById('addHabitBtn').onclick = ()=>{
  const name = document.getElementById('newHabitName').value.trim() || 'Habit';
  const color = document.getElementById('newHabitColor').value;
  state.habits.push({ id: crypto.randomUUID(), name, color, days:{} });
  state.selected = state.habits[state.habits.length-1].id;
  document.getElementById('newHabitName').value='';
  save(state); render();
};

const weeksEl = document.getElementById('weeks'); const legendEl = document.getElementById('legend');
function firstSunday(d){ const ds = new Date(d.getFullYear(), d.getMonth(), d.getDate()); const wd = ds.getDay(); ds.setDate(ds.getDate() - wd); return ds; }
function lastSaturday(d){ const de = new Date(d.getFullYear(), d.getMonth(), d.getDate()); const wd = de.getDay(); de.setDate(de.getDate() + (6 - wd)); return de; }
function daysBetween(a,b){ const out=[]; const d = new Date(a); while(d<=b){ out.push(new Date(d)); d.setDate(d.getDate()+1); } return out; }
function mixColor(hex, ratio){ if(ratio<=0.0001) return '#e5e7eb'; const c = hex.replace('#',''); const r = parseInt(c.slice(0,2),16), g = parseInt(c.slice(2,4),16), b = parseInt(c.slice(4,6),16); const rr = Math.round(ratio*r + (1-ratio)*229); const gg = Math.round(ratio*g + (1-ratio)*231); const bb = Math.round(ratio*b + (1-ratio)*235); return `rgb(${rr},${gg},${bb})`; }
function renderLegend(base){ legendEl.innerHTML = '強度：'; const steps = 5; for(let i=0;i<steps;i++){ const c = document.createElement('div'); c.className='cell'; c.style.background = mixColor(base, i/(steps-1)); legendEl.appendChild(c); } }
function renderBoard(){
  weeksEl.innerHTML='';
  const yearStart = new Date(currentYear,0,1); const yearEnd   = new Date(currentYear,11,31);
  const gridStart = firstSunday(yearStart); const gridEnd   = lastSaturday(yearEnd); const dates = daysBetween(gridStart, gridEnd);
  const isSingle = state.selected !== null; let baseColor = '#16a34a'; let map = {};
  if(isSingle){ const h = state.habits.find(x=>x.id===state.selected); baseColor = h?.color || baseColor; if(h){ Object.keys(h.days).forEach(k=>map[k]=1); } }
  else{ state.habits.forEach(h=>{ Object.keys(h.days).forEach(k=>{ map[k]=(map[k]||0)+1; }) }); baseColor = '#16a34a'; }
  const maxIntensity = Math.max(1, ...Object.values(map), 1); renderLegend(baseColor);
  for(let col=0; col<dates.length; col+=7){
    const column = document.createElement('div'); column.className='col';
    for(let row=0; row<7; row++){
      const d = dates[col+row]; const key = ymd(d); const val = map[key] || 0; const ratio = isSingle ? (val>0?1:0) : (val/maxIntensity);
      const cell = document.createElement('div'); cell.className='cell' + (d<yearStart || d>yearEnd ? ' out': ''); cell.style.background = mixColor(baseColor, ratio);
      cell.title = `${key}  ${isSingle? (val? '✓':'' ) : (val? '×'+val:'')}`;
      cell.onclick = ()=>{ if(!isSingle) return; const h = state.habits.find(x=>x.id===state.selected); if(!h) return; if(h.days[key]) delete h.days[key]; else h.days[key]=1; save(state); renderBoard(); };
      column.appendChild(cell);
    }
    weeksEl.appendChild(column);
  }
}
function render(){ renderHabits(); renderBoard(); } render();
document.getElementById('exportBtn').onclick = ()=>{ const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `activation-board-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href); };
const importFile = document.getElementById('importFile'); document.getElementById('importBtn').onclick = ()=> importFile.click();
importFile.onchange = async (e)=>{ const f = e.target.files[0]; if(!f) return; try{ const txt = await f.text(); const obj = JSON.parse(txt); if(!obj.habits) throw new Error('格式不正確'); state = obj; save(state); render(); }catch(err){ alert('匯入失敗：'+err.message); } };
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js') ); }
</script>
</body>
</html>
